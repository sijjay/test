name: Azure CLI Key Vault Access

on:
  workflow_dispatch:  # Allows manual trigger

jobs:
  azure-auth:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:

      # - name: Azure login
      #   uses: azure/login@v2
      #   with:
      #     client-id: 9de2854e-ce2d-422a-9ebf-514077017382
      #     tenant-id: 0e7f6f8b-dfc2-4a5d-9c14-6f3eb7a8fe8d
      #     allow-no-subscriptions: true

      # WORKS 1
      # - name: az login cli
      #   run: |
      #     az login --service-principal --username 9de2854e-ce2d-422a-9ebf-514077017382 --tenant 0e7f6f8b-dfc2-4a5d-9c14-6f3eb7a8fe8d --federated-token $ACTIONS_ID_TOKEN_REQUEST_TOKEN

      # WORKS 2
      # - name: Azure login
      #   uses: azure/login@v2
      #   with:
      #     client-id: 4722d169-f7d5-44f6-88d4-bfd24adce7f8
      #     tenant-id: 0e7f6f8b-dfc2-4a5d-9c14-6f3eb7a8fe8d
      #     allow-no-subscriptions: true

      # WORKS 1/2
      # - name: Fetch secrets from Azure Key Vault
      #   run: |
      #     SECRET_VALUE=$(az keyvault secret show --name "pilot-test-secret" --vault-name "pilot-kv-main" --query "value" -o tsv)
      #     echo "Fetched secret successfully."
      #     echo "${SECRET_VALUE}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install azure-identity requests

      - name: Fetch secrets from Azure Key Vault
        env:
          AZURE_CLIENT_ID: 4722d169-f7d5-44f6-88d4-bfd24adce7f8
          AZURE_TENANT_ID: 0e7f6f8b-dfc2-4a5d-9c14-6f3eb7a8fe8d
          AZURE_KEY_VAULT_NAME: "pilot-kv-main"
          AZURE_SECRET_NAME: "pilot-test-secret"
        run: python test.py

      
